# 
# Copyright 2021 Google LLC
#


steps:
    - name: 'ubuntu'
      dir: 'infrastructure/layers/$_LAYER_NAME_'
      entrypoint: 'bash'
      args:
      - '-c'
      - |-
        # Set Debain noninteractive to ensure no prompts
        export DEBIAN_FRONTEND=noninteractive

        # Fail on Error
        set -e

        # Install Dependencies
        apt-get update
        apt-get install -y zip curl unzip git apt-transport-https ca-certificates gnupg
        
        # Install Terraform
        curl -o terraform.zip https://releases.hashicorp.com/terraform/0.14.6/terraform_0.14.6_linux_amd64.zip
        unzip terraform.zip
        mv terraform /usr/local/bin/
        chmod +x /usr/local/bin/terraform
        
        # Init and Test Terraform
        terraform init -backend-config=prefix=$_LAYER_NAME_/$_ENVIRONMENT_
        terraform validate
        terraform fmt -recursive -check
        terraform plan -var project=$_DEPLOY_PROJECT_ -var environment=$_ENVIRONMENT_

timeout: 3600s